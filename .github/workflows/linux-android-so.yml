name: Build p7zip for Android

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ["arm64-v8a"]
        # arch: ["arm64-v8a", "x86_64"]
        # bundle: ["Alone2", "Alone", "Alone7z"]
        bundle: ["Alone"]

    steps:
    - name: Checkout p7zip source
      uses: actions/checkout@v4
      with:
        repository: huangshijl/p7zip
        ref: master
        path: p7zip
        fetch-depth: 0  # Ensure full repo is checked out

    - name: Download NDK r29
      run: |
        # Define the NDK version and URL
        NDK_VERSION="r29"
        NDK_URL="https://googledownloads.cn/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
        
        # Create directory for NDK
        NDK_DIR="$GITHUB_WORKSPACE/ndk"
        mkdir -p $NDK_DIR
        
        # Download and unzip NDK, ensuring download success
        echo "Downloading NDK..."
        curl -fL $NDK_URL -o $NDK_DIR/android-ndk-${NDK_VERSION}-linux.zip || { echo "NDK download failed!"; exit 1; }
        
        # Ensure the NDK zip file was downloaded successfully
        if [ ! -f "$NDK_DIR/android-ndk-${NDK_VERSION}-linux.zip" ]; then
          echo "NDK zip file not found!"
          exit 1
        fi
        
        echo "Extracting NDK..."
        unzip -q $NDK_DIR/android-ndk-${NDK_VERSION}-linux.zip -d $NDK_DIR
        
        # Verify if extraction was successful
        if [ ! -d "$NDK_DIR/android-ndk-${NDK_VERSION}" ]; then
          echo "NDK extraction failed!"
          exit 1
        fi
        
        # Set NDK environment variables
        export ANDROID_NDK_HOME="$NDK_DIR/android-ndk-${NDK_VERSION}"
        export NDK=$ANDROID_NDK_HOME
        echo "NDK_HOME set to: $ANDROID_NDK_HOME"
    
    - name: Install build dependencies (including zstd and lz4)
      run: |
        # Install build dependencies
        sudo apt-get update && sudo apt-get install -y make gcc
        sudo apt-get install -y liblz4-dev libzstd-dev

    - name: List files for debugging
      run: |
        echo "Current directory:"
        pwd
        echo "Listing contents of p7zip folder:"
        ls -la p7zip

    - name: Build p7zip-${{ matrix.bundle }} for ${{ matrix.arch }}
      run: |
        cd $GITHUB_WORKSPACE/p7zip
        
        # Set the target architecture and compiler
        case ${{ matrix.arch }} in
          arm64-v8a)
            TARGET_TRIPLE=aarch64-linux-android29
            ;;
        esac
        
        # Export compilers and flags
        export CC=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/clang
        export CXX=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++
        export LD=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/ld
        export CFLAGS="--target=${TARGET_TRIPLE} -fPIC -O2"
        export CXXFLAGS="--target=${TARGET_TRIPLE} -fPIC -O2"
        export LDFLAGS="--target=${TARGET_TRIPLE} -fPIC"

        # Locate the makefile
        MAKEFILE_PATH="CPP/7zip/Bundles/${{ matrix.bundle }}/makefile.gcc"
        if [ ! -f "$MAKEFILE_PATH" ]; then
          echo "Error: makefile.gcc not found at $MAKEFILE_PATH"
          ls -la CPP/7zip/Bundles/${{ matrix.bundle }}/
          exit 1
        fi
        
        cd $(dirname "$MAKEFILE_PATH")
        make -f makefile.gcc clean
        make -f makefile.gcc -j$(nproc)

    - name: Create output directory
      run: mkdir -p $GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}

    - name: Extract compiled binaries/libraries
      run: |
        OUTPUT_DIR="$GITHUB_WORKSPACE/p7zip/CPP/7zip/Bundles/${{ matrix.bundle }}/_o"
        if [ ! -d "$OUTPUT_DIR" ]; then
          echo "Error: Compiled output directory $_o not found"
          ls -la $GITHUB_WORKSPACE/p7zip/CPP/7zip/Bundles/${{ matrix.bundle }}/
          exit 1
        fi
        cp -r $OUTPUT_DIR/* $GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: p7zip-android-${{ matrix.arch }}-${{ matrix.bundle }}
        path: $GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}/
        retention-days: 30
