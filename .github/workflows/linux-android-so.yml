name: Build p7zip for Android (JNI)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        abi: [arm64-v8a]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1️⃣ 安装 JDK（NDK 需要）
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 2️⃣ 安装 Android SDK + NDK（官方，稳定）
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r27c
        run: |
          sdkmanager "ndk;27.2.12479018"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_PATH

      # 3️⃣ 设置编译环境
      - name: Set build env
        run: |
          echo "API=21" >> $GITHUB_ENV
          echo "ABI=${{ matrix.abi }}" >> $GITHUB_ENV

      # 4️⃣ 编译 p7zip (7zz)
      - name: Build 7zz (static)
        run: |
          export NDK=$ANDROID_NDK_HOME
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64

          export CC=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang
          export CXX=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          cd p7zip/CPP/7zip/Bundles/Alone7z

          make -f makefile.gcc \
            CC="$CC" \
            CXX="$CXX" \
            AR="$AR" \
            RANLIB="$RANLIB" \
            STRIP="$STRIP" \
            -j$(nproc)

      # 5️⃣ 收集产物
      - name: Collect artifacts
        run: |
          mkdir -p out/${{ matrix.abi }}
          cp p7zip/CPP/7zip/Bundles/Alone7z/7zz out/${{ matrix.abi }}/

      # 6️⃣ 上传
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 7zz-${{ matrix.abi }}
          path: out/${{ matrix.abi }}/7zz