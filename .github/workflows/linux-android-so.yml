name: Build p7zip for Android

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ["arm64-v8a", "x86_64"]
        bundle: ["Alone2", "Alone", "Alone7z"]

    steps:
    - name: Install LZ4
      run: |
        git clone --recursive https://github.com/lz4/lz4.git
        cd lz4
        make
        sudo make install

    - name: Install Zstandard
      run: |
        git clone --recursive https://github.com/facebook/zstd.git
        cd zstd
        make
        sudo make install
        
    - name: Checkout p7zip source
      uses: actions/checkout@v3
      with:
        repository: huangshijl/p7zip
        ref: master
        path: p7zip
        fetch-depth: 0  # Ensure full repo is checked out

    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r29
        add-to-path: true

    - name: Export NDK path
      run: |
        export NDK=$ANDROID_NDK_HOME
        echo "NDK Path: $NDK"

    - name: List files for debugging
      run: |
        echo "Current directory:"
        pwd
        echo "Listing contents of p7zip folder:"
        ls -la p7zip

    - name: Build p7zip-${{ matrix.bundle }} for ${{ matrix.arch }}
      run: |
        cd $GITHUB_WORKSPACE/p7zip
        case ${{ matrix.arch }} in
          arm64-v8a)
            TARGET_TRIPLE=aarch64-linux-android29
            ;;
          x86_64)
            TARGET_TRIPLE=x86_64-linux-android29
            ;;
        esac
        export CC=${TARGET_TRIPLE}-clang
        export CXX=${TARGET_TRIPLE}-clang++
        export LD=${TARGET_TRIPLE}-ld
        export CFLAGS="--target=${TARGET_TRIPLE} -fPIC -O2"
        export CXXFLAGS="--target=${TARGET_TRIPLE} -fPIC -O2"
        export LDFLAGS="--target=${TARGET_TRIPLE} -fPIC"
        
        MAKEFILE_PATH="CPP/7zip/Bundles/${{ matrix.bundle }}/makefile.gcc"
        if [ ! -f "$MAKEFILE_PATH" ]; then
          echo "Error: makefile.gcc not found at $MAKEFILE_PATH"
          ls -la CPP/7zip/Bundles/${{ matrix.bundle }}/
          exit 1
        fi
        
        cd $(dirname "$MAKEFILE_PATH")
        make -f makefile.gcc clean
        make -f makefile.gcc -j$(nproc)

    - name: Create output directory
      run: mkdir -p $GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}

    - name: Extract compiled binaries/libraries
      run: |
        OUTPUT_DIR="$GITHUB_WORKSPACE/p7zip/CPP/7zip/Bundles/${{ matrix.bundle }}/_o"
        if [ ! -d "$OUTPUT_DIR" ]; then
          echo "Error: Compiled output directory $_o not found"
          ls -la $GITHUB_WORKSPACE/p7zip/CPP/7zip/Bundles/${{ matrix.bundle }}/
          exit 1
        fi
        cp -r $OUTPUT_DIR/* $GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: p7zip-android-${{ matrix.arch }}-${{ matrix.bundle }}
        path: $GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}/
        retention-days: 30
