name: Build p7zip for Android

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ["arm64-v8a"]
        bundle: ["Alone"]

    steps:
    - name: Checkout p7zip source
      uses: actions/checkout@v4
      with:
        repository: huangshijl/p7zip
        ref: master
        path: p7zip
        fetch-depth: 0

    - name: Download NDK r29
      run: |
        NDK_VERSION="r29"
        NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
        NDK_DIR="$GITHUB_WORKSPACE/ndk"
        mkdir -p $NDK_DIR
        
        echo "Downloading NDK r29..."
        curl -fsSL $NDK_URL -o $NDK_DIR/ndk.zip
        unzip -q $NDK_DIR/ndk.zip -d $NDK_DIR
        export ANDROID_NDK_HOME="$NDK_DIR/android-ndk-${NDK_VERSION}"
        echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        
        # ✅ 关键：将工具链加入PATH
        echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Install essential build tools
      run: sudo apt-get update && sudo apt-get install -y make gcc  # ✅ 仅保留基础工具

    - name: Build p7zip
      run: |
        cd $GITHUB_WORKSPACE/p7zip
        
        # ✅ 正确设置交叉编译环境
        case "${{ matrix.arch }}" in
          arm64-v8a)
            TARGET_TRIPLE=aarch64-linux-android29
            ;;
        esac
        
        # ✅ 修复编译/链接标志
        export CC=clang
        export CXX=clang++
        export CFLAGS="--target=${TARGET_TRIPLE} -fPIC -O2 -D__ANDROID__"
        export CXXFLAGS="--target=${TARGET_TRIPLE} -fPIC -O2 -D__ANDROID__"
        export LDFLAGS="--target=${TARGET_TRIPLE}"  # ✅ 移除无效的-fPIC
        
        # ✅ 修复常见编译警告
        export COMMON_FLAGS="-Wno-unused-command-line-argument"
        
        MAKEFILE_DIR="CPP/7zip/Bundles/${{ matrix.bundle }}"
        cd $MAKEFILE_DIR
        
        # ✅ 清理并构建
        make -f makefile.gcc clean
        make -f makefile.gcc \
          CC=$CC \
          CXX=$CXX \
          CFLAGS="$CFLAGS $COMMON_FLAGS" \
          CXXFLAGS="$CXXFLAGS $COMMON_FLAGS" \
          LDFLAGS="$LDFLAGS" \
          -j$(nproc) \
          VERBOSE=1  # ✅ 启用详细日志

    - name: Package artifacts
      run: |
        OUTPUT_DIR="$GITHUB_WORKSPACE/p7zip/CPP/7zip/Bundles/${{ matrix.bundle }}/_o"
        ARTIFACT_DIR="$GITHUB_WORKSPACE/output/${{ matrix.arch }}-${{ matrix.bundle }}"
        mkdir -p $ARTIFACT_DIR
        cp $OUTPUT_DIR/* $ARTIFACT_DIR/ 2>/dev/null || :  # 忽略错误继续
        ls -la $ARTIFACT_DIR

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: p7zip-android-${{ matrix.arch }}-${{ matrix.bundle }}
        path: ${{ github.workspace }}/output/
        retention-days: 30
